---
phase: 02-server-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/airflow_unfactor/knowledge.py
  - tests/test_knowledge.py
autonomous: true
requirements:
  - SRVR-02
  - SRVR-03

must_haves:
  truths:
    - "suggestions('KubernetesPodOp', knowledge) returns ['KubernetesPodOperator'] via fuzzy match"
    - "suggestions('kubernetesPodOp', knowledge) returns ['KubernetesPodOperator'] despite case difference"
    - "suggestions('CompletelyUnknown', {}) returns empty list (no false positives)"
    - "lookup('ShortCircuitOperator', {}) returns found+fallback instead of not_found"
    - "lookup('BranchPythonOperator', {}) returns found+fallback instead of not_found"
    - "lookup('EmptyOperator', {}) returns found+fallback with guidance to remove placeholder"
    - "FALLBACK_KNOWLEDGE contains at least 15 entries total"
  artifacts:
    - path: "src/airflow_unfactor/knowledge.py"
      provides: "difflib-based suggestions() and expanded FALLBACK_KNOWLEDGE"
      contains: "difflib.get_close_matches"
    - path: "tests/test_knowledge.py"
      provides: "Tests for fuzzy matching and new fallback entries"
      contains: "TestSuggestionsFuzzy"
  key_links:
    - from: "src/airflow_unfactor/knowledge.py::suggestions()"
      to: "difflib.get_close_matches"
      via: "case-insensitive wrapper"
      pattern: "get_close_matches.*cutoff"
    - from: "src/airflow_unfactor/knowledge.py::lookup()"
      to: "FALLBACK_KNOWLEDGE"
      via: "fallback path in lookup()"
      pattern: "FALLBACK_KNOWLEDGE"
---

<objective>
Replace the character-overlap suggestion algorithm with `difflib.SequenceMatcher` and expand FALLBACK_KNOWLEDGE from 6 to 15 entries covering the highest-frequency operators users encounter.

Purpose: Users who misspell an operator name get meaningful "did you mean?" suggestions instead of false positives from character counting. Users querying common operators not in Colin output get translation guidance instead of `not_found`.

Output: Updated `knowledge.py` with difflib-based `suggestions()`, 15 FALLBACK_KNOWLEDGE entries, and new tests validating both behaviors.
</objective>

<execution_context>
@/Users/gcoyne/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gcoyne/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-quality/02-RESEARCH.md
@src/airflow_unfactor/knowledge.py
@tests/test_knowledge.py

<interfaces>
<!-- Executor needs these existing signatures — modify internals only, preserve public API. -->

From src/airflow_unfactor/knowledge.py:
```python
FALLBACK_KNOWLEDGE: dict[str, dict[str, Any]]  # Module-level dict, keyed by concept name
def load_knowledge(colin_output_dir: str = "colin/output") -> dict[str, Any]
def lookup(concept: str, knowledge: dict[str, Any]) -> dict[str, Any]
def suggestions(query: str, knowledge: dict[str, Any]) -> list[str]
```

Existing FALLBACK_KNOWLEDGE keys (6 entries):
- PythonOperator, BashOperator, XCom, TaskGroup, DAG, postgres_default

Each entry structure (minimum required fields):
```python
{
    "concept_type": str,  # "operator", "concept", "pattern", "connection"
    "airflow": {"name": str, ...},  # or {"description": str}
    "prefect_equivalent": {"pattern": str, ...},
    "translation_rules": list[str],
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace suggestions() with difflib and expand FALLBACK_KNOWLEDGE to 15 entries</name>
  <files>src/airflow_unfactor/knowledge.py</files>
  <action>
Two changes in knowledge.py:

**1. Replace `suggestions()` body with `difflib.get_close_matches`:**

Add `import difflib` at the top of the file.

Replace the entire body of `suggestions()` (lines 201-221) with a case-insensitive `difflib.get_close_matches` wrapper. The new implementation:
- Collects all keys from `knowledge` and `FALLBACK_KNOWLEDGE` (deduplicated, order-preserved — keep existing dedup logic)
- Builds a `lower_to_orig` mapping: `{k.lower(): k for k in unique_keys}`
- Calls `difflib.get_close_matches(query.lower(), lower_keys, n=5, cutoff=0.4)`
- Returns original-case names: `[lower_to_orig[k] for k in close]`

Do NOT change the function signature or docstring. Preserve the `query` and `knowledge` parameters.

**2. Add 9 new entries to FALLBACK_KNOWLEDGE (bringing total from 6 to 15):**

Add these entries AFTER the existing `postgres_default` entry, using the same structure as existing entries. Each needs `concept_type`, `airflow` (with `name` and `module` for operators), `prefect_equivalent` (with `pattern` and `description`), and `translation_rules` (list of strings).

New entries to add:
1. **ShortCircuitOperator** — `concept_type: "operator"`, module `airflow.operators.python`, pattern: `@task with conditional return + flow control`. Rules: replace with @task returning bool, use if/else in @flow to skip downstream.
2. **BranchPythonOperator** — `concept_type: "operator"`, module `airflow.operators.python`, pattern: `Python if/else in @flow`. Rules: replace with if/else block, python_callable return becomes branch condition, Python control flow handles natively.
3. **EmptyOperator** — `concept_type: "operator"`, module `airflow.operators.empty`, pattern: `Remove or use pass`. Rules: remove nodes (pure placeholders), restructure task calls directly if used for wiring.
4. **DummyOperator** — `concept_type: "operator"`, module `airflow.operators.dummy`, pattern: `Remove or use pass`. Rules: same as EmptyOperator (Airflow <2.4 name), remove nodes.
5. **EmailOperator** — `concept_type: "operator"`, module `airflow.operators.email`, pattern: `prefect-email or smtplib @task`. Rules: use `prefect-email` EmailServerCredentials block, or wrap smtplib in @task.
6. **TriggerDagRunOperator** — `concept_type: "operator"`, module `airflow.operators.trigger_dagrun`, pattern: `run_deployment() from prefect.deployments`. Rules: replace with `run_deployment()` call, DAG ID becomes deployment name, conf becomes parameters.
7. **ExternalTaskSensor** — `concept_type: "operator"`, module `airflow.sensors.external_task`, pattern: `Automation trigger or flow parameter`. Rules: use Prefect Automations to trigger on upstream completion, or pass results explicitly.
8. **FileSensor** — `concept_type: "operator"`, module `airflow.sensors.filesystem`, pattern: `@task polling loop or watchdog`. Rules: wrap Path.exists() check in @task with retry/delay, or use filesystem event trigger.
9. **PythonSensor** — `concept_type: "operator"`, module `airflow.sensors.python`, pattern: `@task with retry`. Rules: the poke callable becomes a @task, use Prefect retries (max_retries + retry_delay) for polling behavior.
  </action>
  <verify>
    <automated>cd /Users/gcoyne/src/prefect/airflow-unfactor && uv run python -c "from airflow_unfactor.knowledge import suggestions, FALLBACK_KNOWLEDGE; assert len(FALLBACK_KNOWLEDGE) >= 15, f'Only {len(FALLBACK_KNOWLEDGE)} entries'; r = suggestions('KubernetesPodOp', {}); assert 'KubernetesPodOperator' not in r or True; print(f'OK: {len(FALLBACK_KNOWLEDGE)} entries, suggestions working')"</automated>
  </verify>
  <done>
    - `suggestions()` uses `difflib.get_close_matches` with cutoff=0.4 and case-insensitive matching
    - FALLBACK_KNOWLEDGE has exactly 15 entries (6 existing + 9 new)
    - No signature changes to public API
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for fuzzy suggestions and new fallback operators</name>
  <files>tests/test_knowledge.py</files>
  <action>
Add two new test classes to `tests/test_knowledge.py`:

**1. `TestSuggestionsFuzzy` class** — tests for the difflib-based suggestions:

- `test_fuzzy_typo_match`: `suggestions("KubernetesPodOp", {"KubernetesPodOperator": {"concept_type": "operator"}})` returns a list containing `"KubernetesPodOperator"`. This is the SRVR-02 success criterion.
- `test_fuzzy_case_insensitive`: `suggestions("kubernetesPodOp", {"KubernetesPodOperator": {"concept_type": "operator"}})` returns `"KubernetesPodOperator"` despite mixed case.
- `test_fuzzy_no_false_positives`: `suggestions("CompletelyUnknownXYZ123", {})` returns an empty list (nothing in fallback should match this).
- `test_fuzzy_returns_original_case`: `suggestions("pythonop", {})` returns entries with original casing (e.g., `"PythonOperator"`, not `"pythonoperator"`).

**2. `TestFallbackExpanded` class** — tests for new fallback entries:

- `test_fallback_count`: `assert len(FALLBACK_KNOWLEDGE) >= 15`
- `test_shortcircuit_fallback`: `lookup("ShortCircuitOperator", {})` returns `status="found"` with `source="fallback"`.
- `test_branch_python_fallback`: `lookup("BranchPythonOperator", {})` returns `status="found"` with `source="fallback"`.
- `test_empty_operator_fallback`: `lookup("EmptyOperator", {})` returns `status="found"` with `source="fallback"`.
- `test_trigger_dagrun_fallback`: `lookup("TriggerDagRunOperator", {})` returns `status="found"` with `source="fallback"`.
- `test_external_task_sensor_fallback`: `lookup("ExternalTaskSensor", {})` returns `status="found"` with `source="fallback"`.
- `test_each_fallback_has_required_fields`: Parametrized test over all FALLBACK_KNOWLEDGE values — each must have `concept_type`, `airflow`, `prefect_equivalent`, and `translation_rules` keys.

Import `FALLBACK_KNOWLEDGE` from `airflow_unfactor.knowledge` (add to existing import line).
  </action>
  <verify>
    <automated>cd /Users/gcoyne/src/prefect/airflow-unfactor && uv run pytest tests/test_knowledge.py -x -v 2>&1 | tail -30</automated>
  </verify>
  <done>
    - All new tests pass
    - Existing tests still pass (no regressions)
    - Full test suite green: `uv run pytest` exits 0
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/test_knowledge.py -x -v` — all tests pass including new fuzzy and fallback tests
2. `uv run pytest` — full suite green (66+ tests, no regressions)
3. `uv run python -c "from airflow_unfactor.knowledge import suggestions; print(suggestions('KubernetesPodOp', {'KubernetesPodOperator': {}}))"` — outputs `['KubernetesPodOperator']`
4. `uv run python -c "from airflow_unfactor.knowledge import lookup; r = lookup('ShortCircuitOperator', {}); print(r['status'], r['source'])"` — outputs `found fallback`
</verification>

<success_criteria>
- SRVR-02: `suggestions("KubernetesPodOp", knowledge_with_k8s)` returns `["KubernetesPodOperator"]` via SequenceMatcher fuzzy match
- SRVR-03: `lookup("ShortCircuitOperator", {})` returns `found` + `fallback` (and same for all 9 new operators)
- SRVR-03: `len(FALLBACK_KNOWLEDGE) >= 15`
- Zero test regressions across full suite
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-quality/02-01-SUMMARY.md`
</output>
